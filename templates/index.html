<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Splitter</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’°</text></svg>">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container" style="max-width: 1200px;">
        <h1><a href="/" style="text-decoration: none; color: inherit;">ðŸ’° Bill Splitter</a></h1>
        
        <div class="app-layout" style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
            <!-- Sidebar for Participants -->
            <div class="sidebar" style="flex: 0 0 250px; min-width: 250px;">
                <div class="card">
                    <h2>Participants <span id="uniquePeopleCount" style="font-size: 0.8em; color: #666; font-weight: normal;">(0)</span></h2>
                    <div id="participantsList" class="participants-list"></div>
                </div>
                
                <div class="card">
                    <h2>Share</h2>
                    <button id="shareBtn" class="btn btn-primary" style="background: #805ad5;">Share Split</button>
                    <div id="shareLinks" style="display: none; margin-top: 15px;">
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 0.85em; font-weight: bold; color: #555;">View Only Link:</label>
                            <div class="input-group">
                                <input type="text" id="viewLink" readonly>
                                <button class="btn btn-copy" id="copyViewLink">Copy</button>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 0.85em; font-weight: bold; color: #555;">Edit Link:</label>
                            <div class="input-group">
                                <input type="text" id="editLink" readonly>
                                <button class="btn btn-copy" id="copyEditLink">Copy</button>
                            </div>
                            <div style="font-size: 0.75em; color: #e53e3e; margin-top: 2px;">Don't share this with everyone!</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>History</h2>
                    <p style="font-size: 0.8em; color: #666; margin-bottom: 10px;">Local archives of your sessions.</p>
                    <button id="archiveBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 15px; background-color: #718096;">Archive Current</button>
                    <div id="historyList" class="history-list" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- History items will appear here -->
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content" style="flex: 1; min-width: 300px;">
                <div class="card">
                    <h2>Add Expense</h2>
                    
                    <!-- Tabs -->
                    <div class="tabs" style="display: flex; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px;">
                        <button class="tab-btn active" onclick="switchTab('manual')" id="tab-btn-manual" style="padding: 10px 20px; border: none; background: none; border-bottom: 2px solid #4299e1; font-weight: bold; cursor: pointer; color: #2d3748;">Manual</button>
                        <button class="tab-btn" onclick="switchTab('image')" id="tab-btn-image" style="padding: 10px 20px; border: none; background: none; border-bottom: 2px solid transparent; cursor: pointer; color: #718096;">Scan Image</button>
                        <button class="tab-btn" onclick="switchTab('text')" id="tab-btn-text" style="padding: 10px 20px; border: none; background: none; border-bottom: 2px solid transparent; cursor: pointer; color: #718096;">Paste Text</button>
                        <button class="tab-btn" onclick="switchTab('ai')" id="tab-btn-ai" style="padding: 10px 20px; border: none; background: none; border-bottom: 2px solid transparent; cursor: pointer; color: #718096;">AI</button>
                    </div>

                    <!-- Manual Tab (Existing Form) -->
                    <div id="tab-manual" class="tab-content">
                        <form id="addPersonForm">
                            <div class="form-group">
                                <label for="personName">Name:</label>
                                <input type="text" id="personName" required placeholder="Who paid?" autocomplete="off">
                                <select id="participantSelect" style="display: none; width: 100%; margin-top: 8px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; background-color: white; cursor: pointer;">
                                    <option value="">-- Select existing participant --</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="description">Description (Optional):</label>
                                <input type="text" id="description" placeholder="e.g. Drinks, Taxi">
                            </div>
                            
                            <div class="form-group">
                                <label for="amountSpent">Amount Spent:</label>
                                <input type="text" id="amountSpent" inputmode="decimal" placeholder="0.00" required>
                            </div>

                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" id="hasExpenseTip">
                                    Tip/Tax on spent
                                </label>
                            </div>

                            <div class="form-group" id="expenseTipGroup" style="display: none;">
                                <label for="expenseTipPercentage">Tip/Tax Percentage (%):</label>
                                <input type="text" id="expenseTipPercentage" inputmode="decimal" placeholder="10">
                            </div>
                            
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" id="isSponsor">
                                    Is Sponsor
                                </label>
                            </div>

                            <div class="form-group" id="sponsorAmountGroup" style="display: none;">
                                <label for="sponsorAmount">Sponsor Amount:</label>
                                <input type="text" id="sponsorAmount" inputmode="decimal" placeholder="0.00">
                            </div>
                            
                            <div class="form-group">
                                <label for="paidBy">Who will pay this expense?</label>
                                <select id="paidBy" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; background-color: white;">
                                    <option value="">-- Self (person above) --</option>
                                </select>
                                <small style="color: #666; display: block; margin-top: 4px;">Select who will actually pay for this expense</small>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary" id="submitBtn">Add</button>
                                <button type="button" class="btn" id="cancelEditBtn" style="display: none; background: #718096; color: white;">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <!-- Image Tab -->
                    <div id="tab-image" class="tab-content" style="display: none;">
                        <div class="form-group">
                            <label for="imagePersonName">Name:</label>
                            <input type="text" id="imagePersonName" placeholder="Who paid?" autocomplete="off">
                        </div>

                        <div class="form-group">
                            <label style="display: block; margin-bottom: 10px;">Upload Receipt Image</label>
                            <div style="border: 2px dashed #cbd5e0; border-radius: 8px; padding: 20px; text-align: center; background: #f7fafc;">
                                <input type="file" id="receiptImage" accept="image/*" style="display: none;" onchange="handleImageSelect(this)">
                                <button onclick="document.getElementById('receiptImage').click()" class="btn" style="background: #4a5568; color: white; margin-bottom: 10px;">Choose Image</button>
                                <div id="imageFileName" style="color: #718096; font-size: 0.9em;">No file selected</div>
                            </div>
                        </div>

                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" id="imageHasExpenseTip">
                                Tip/Tax on spent
                            </label>
                        </div>

                        <div class="form-group" id="imageExpenseTipGroup" style="display: none;">
                            <label for="imageExpenseTipPercentage">Tip/Tax Percentage (%):</label>
                            <input type="text" id="imageExpenseTipPercentage" inputmode="decimal" placeholder="10">
                        </div>

                        <button onclick="processImage()" class="btn btn-primary" id="processImageBtn" disabled style="width: 100%; opacity: 0.5;">Process Receipt</button>
                        <div id="imageLoading" style="display: none; margin-top: 15px; text-align: center; color: #4299e1;">
                            Processing image with AI... <span class="loading-dots">...</span>
                        </div>
                    </div>

                    <!-- Text Tab -->
                    <div id="tab-text" class="tab-content" style="display: none;">
                        <div class="form-group">
                            <label for="textPersonName">Name:</label>
                            <input type="text" id="textPersonName" placeholder="Who paid?" autocomplete="off">
                        </div>

                        <div class="form-group">
                            <label for="receiptText">Paste Receipt Text</label>
                            <textarea id="receiptText" rows="8" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: monospace; font-size: 0.9em;" placeholder="Paste the text content of the receipt here..."></textarea>
                        </div>

                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" id="textHasExpenseTip">
                                Tip/Tax on spent
                            </label>
                        </div>

                        <div class="form-group" id="textExpenseTipGroup" style="display: none;">
                            <label for="textExpenseTipPercentage">Tip/Tax Percentage (%):</label>
                            <input type="text" id="textExpenseTipPercentage" inputmode="decimal" placeholder="10">
                        </div>

                        <button onclick="processText()" class="btn btn-primary" style="width: 100%;">Process Text</button>
                        <div id="textLoading" style="display: none; margin-top: 15px; text-align: center; color: #4299e1;">
                            Processing text with AI... <span class="loading-dots">...</span>
                        </div>
                    </div>

                    <!-- AI Tab -->
                    <div id="tab-ai" class="tab-content" style="display: none;">
                        <div class="form-group">
                            <label for="aiDescription">Describe Expenses</label>
                            <textarea id="aiDescription" rows="8" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: monospace; font-size: 0.9em;" placeholder="Describe who paid what... e.g. Alice paid 50 for lunch, Bob paid 20 for drinks"></textarea>
                        </div>

                        <button onclick="processAiSplit()" class="btn btn-primary" style="width: 100%;">Process with AI</button>
                        <div id="aiLoading" style="display: none; margin-top: 15px; text-align: center; color: #4299e1;">
                            Processing with AI... <span class="loading-dots">...</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2 style="margin-bottom: 0;">Expenses <span id="expensesCount" style="font-size: 0.8em; color: #666; font-weight: normal;">(0)</span></h2>
                        <button id="clearAllBtn" class="btn btn-danger" style="width: auto; padding: 8px 16px;">Clear All</button>
                    </div>
                    <div style="background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; color: #4a5568; display: flex; gap: 15px; flex-wrap: wrap;">
                        <span><strong>Total Spent:</strong> $<span id="expensesTotal">0.00</span></span>
                        <span style="color: #cbd5e0;">|</span>
                        <span><strong>Total Sponsor:</strong> $<span id="expensesSponsor">0.00</span></span>
                    </div>
                    <div id="peopleList" class="people-list"></div>
                </div>

        </div>

        <div class="sidebar-right" style="flex: 0 0 300px; min-width: 300px;">
            <div class="card">
                <h2>Settings</h2>
                <div class="form-group">
                    <label for="fundAmount">Fund / Discount Amount:</label>
                    <input type="text" id="fundAmount" inputmode="decimal" placeholder="0.00">
                    <small style="color: #666; display: block; margin-top: 4px;">Amount available to cover expenses before splitting (e.g. team budget)</small>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="includeSponsorInSplit" checked>
                        Include sponsors in equal split
                    </label>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="addTip">
                        Add Tip/Tax
                    </label>
                </div>
                <div class="form-group" id="tipAmountGroup" style="display: none;">
                    <label for="tipPercentage">Tip/Tax Percentage (%):</label>
                    <input type="number" id="tipPercentage" value="10" min="0" step="0.1">
                </div>
                <button id="calculateBtn" class="btn btn-success">Calculate Split</button>
            </div>

            <div id="resultsSection" class="card results-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin-bottom: 0;">Results</h2>
                    <div style="display: flex; gap: 5px;">
                        <button id="exportBtn" class="btn" style="background: #276749; color: white; padding: 6px 12px; font-size: 0.9em; width: auto;">CSV</button>
                        <button id="exportExcelBtn" class="btn" style="background: #2f855a; color: white; padding: 6px 12px; font-size: 0.9em; width: auto;">Excel</button>
                        <button id="emailBtn" class="btn" style="background: #4299e1; color: white; padding: 6px 12px; font-size: 0.9em; width: auto;">Email</button>
                    </div>
                </div>
                <div class="summary">
                    <p><strong>Total Spent:</strong> $<span id="totalSpent">0.00</span></p>
                    <p id="tipRow" style="display: none;"><strong>Tip/Tax (<span id="tipPercentDisplay">0</span>%):</strong> $<span id="totalTip">0.00</span></p>
                    <p><strong>Total Sponsored:</strong> $<span id="totalSponsored">0.00</span></p>
                    <p id="fundRow" style="display: none;"><strong>Fund Used:</strong> $<span id="fundUsed">0.00</span></p>
                    <p><strong>Amount to Share:</strong> $<span id="amountToShare">0.00</span></p>
                    <p><strong>Number of Participants:</strong> <span id="numParticipants">0</span></p>
                    <p><strong>Per Person Share:</strong> $<span id="perPersonShare">0.00</span></p>
                </div>
                <h3>Settlements</h3>
                <div id="settlementsList" class="settlements-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Email Modal -->
<div id="emailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 500px; margin: 0;">
        <h3>Send Results via Email</h3>
        <div class="form-group">
            <label for="emailRecipients">Recipients (comma separated):</label>
            <input type="text" id="emailRecipients" placeholder="email1@example.com, email2@example.com">
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="cancelEmailBtn" class="btn" style="background: #718096; color: white; width: auto;">Cancel</button>
            <button id="sendEmailBtn" class="btn btn-primary" style="width: auto;">Send</button>
        </div>
    </div>
</div>

    <script src="/static/script.js?v=1"></script>
</body>
</html>
